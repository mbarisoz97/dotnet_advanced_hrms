@attribute [Route(PageRouting.Title.Index)]
@attribute [StreamRendering]
@attribute [Authorize]

@inject IToastService ToastService
@inject IEmployeeTitleClient EmployeeTitleClient

<MudTable Items="@_employeeTitles"
          Dense="true"
          Hover="true"
          Loading="@_loading"
          Bordered="true"
          Striped="true"
          Filter="new Func<ReadEmployeeTitleModel, bool>(SearchFilter)">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Employee Titles</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="_searchString" Placeholder="Search Employee Title" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        <MudTooltip Text="Add New Title">
            <MudIconButton Size="Size.Medium" Color="Color.Success" Icon="@Icons.Material.Filled.Add"/>
        </MudTooltip>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Title</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Title">@context.TitleName</MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    private IEnumerable<ReadEmployeeTitleModel>? _employeeTitles;

    private string _searchString = "";

    private bool _loading;
    private void ShowLoadingBar()
    {
        _loading = true;
    }
    private void HideLoadingBar()
    {
        _loading = false;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadEmployeeTitles();
    }

    private async Task LoadEmployeeTitles()
    {
        ShowLoadingBar();
        await GetEmployeeTitles();
        HideLoadingBar();
    }
    private async Task GetEmployeeTitles()
    {
        var response = await EmployeeTitleClient.GetAllTitles();
        if (response.StatusCode == HttpStatusCode.OK)
        {
            _employeeTitles = response.Content ?? [];
        }
        else
        {
            ToastService.ShowError($"Could not load employee titles. Service returned {response.StatusCode}");
        }
    }

    private bool SearchFilter(ReadEmployeeTitleModel element) => Search(element, _searchString);
    private bool Search(ReadEmployeeTitleModel element, string searchString)
    {
        if (element == null)
        {
            return false;
        }

        return (string.IsNullOrWhiteSpace(searchString) || element.TitleName!.Contains(searchString, StringComparison.OrdinalIgnoreCase));
    }
}